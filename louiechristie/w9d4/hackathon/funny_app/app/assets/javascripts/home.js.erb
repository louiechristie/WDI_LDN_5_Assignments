var FunnyPictures = FunnyPictures || {};

FunnyPictures.hideAll = function() {
  
}

FunnyPictures.createBackground = function(layer, stage, url, show) {
  var background = new Image();
  background.src = url;
  background.onload = function() {
    var background_k = new Kinetic.Image({
      x: 0,
      y: 0,
      image: background,
      width: 480,
      height:480,
    });
    layer.add(background_k);
    stage.add(layer);
    if (show === false) {
      layer.hide();
    }
  };
};

FunnyPictures.createMustache = function(layer, stage) {
  var mustache = new Image();
  mustache.src = '<%= asset_path('mustache.png') %>';
  mustache.onload = function() {
    var mustache_k = new Kinetic.Image({
      x: 240-(100/2),
      y: 240-(38/2),
      image: mustache,
      width: 100,
      height: 38,
      draggable: true
    });
    mustache_k.on('mouseover', function() {
      document.body.style.cursor = 'pointer';
    });
    mustache_k.on('mouseout', function() {
      document.body.style.cursor = 'default';
    });
    layer.add(mustache_k);
    stage.add(layer);
    mustache_k.moveToTop();
    layer.hide();
  };
};

FunnyPictures.createHat = function(layer, stage) {
  var hat = new Image();
  hat.src = '<%= asset_path('top_hat.png') %>';
  hat.onload = function() {
    var hat_k = new Kinetic.Image({
      x: 120-(190/2),
      y: 120-(162/2),
      image: hat,
      width: 190,
      height: 162,
      draggable: true
    });
    hat_k.on('mouseover', function() {
      document.body.style.cursor = 'pointer';
    });
    hat_k.on('mouseout', function() {
      document.body.style.cursor = 'default';
    });
    layer.add(hat_k);
    stage.add(layer);
    hat_k.moveToTop();
    layer.hide();
  };
};


FunnyPictures.setup = function() {

  // Setup layers
  var stage = new Kinetic.Stage({
    container: 'container',
    width: 480,
    height: 480
  });
  var background_layer = new Kinetic.Layer();
  var mustache_layer = new Kinetic.Layer();
  var hat_layer = new Kinetic.Layer();

  var pavling_layer = new Kinetic.Layer();

  FunnyPictures.createBackground(pavling_layer, stage, '/assets/pavling.png', false);
  FunnyPictures.createBackground(background_layer, stage, '/assets/silhouette.png', true);
  FunnyPictures.createMustache(mustache_layer, stage);
  FunnyPictures.createHat(hat_layer, stage)

  background_layer.show();
  var show_pavling_toggle = false;
  var show_mustache_toggle = false;
  var show_hat_toggle = false;

  // add button event bindings
  document.getElementById('mustache').addEventListener('click', function() {
    if (show_mustache_toggle === false) {
      mustache_layer.show();
      mustache_layer.draw();
      show_mustache_toggle = true;
    } else {
      mustache_layer.hide();
      mustache_layer.draw();
      show_mustache_toggle = false;
    };
  }, false);

  document.getElementById('hat').addEventListener('click', function() {
    if (show_hat_toggle === false) {
      hat_layer.show();
      hat_layer.draw();
      show_hat_toggle = true;
    } else {
      hat_layer.hide();
      hat_layer.draw();
      show_hat_toggle = false;
    };
  }, false);

  document.getElementById('pavling').addEventListener('click', function() {
    if (show_pavling_toggle === false) {
      pavling_layer.show();
      pavling_layer.draw();
      show_pavling_toggle = true;
    } else {
      pavling_layer.hide();
      pavling_layer.draw();
      show_pavling_toggle = false;
    };
    
  }, false);

  // Save button
  $('#save').on('click', function() {
    stage.toDataURL({
      callback: function(dataUrl) {
        document.getElementById('canvasImg').src = dataUrl;      }
    });
  });

  // Change background
  $('#add_image').on('click', function() {
    url = '/assets/dan.png'
    FunnyPictures.showBackground(layer, stage, url);
  });
  
};

$(FunnyPictures.setup)